!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("valtio/vanilla"),require("yjs"),require("fast-deep-equal")):"function"==typeof define&&define.amd?define(["exports","valtio/vanilla","yjs","fast-deep-equal"],t):t((e||self).valtioYjs={},e.vanilla,e.yjs,e.fastDeepEqual)}(this,function(e,t,r,n){function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o=a(r),f=i(n),s=function(e){return"object"==typeof e&&null!==e},l=function(e){return null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e},u=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e},c=function(e,t,r){e?e.transact(r,t.transactionOrigin):r()},y=function e(r,n,i){void 0===i&&(i={});var a=new WeakMap,u=function(t,r){c(n.doc,i,function(){if(!s(t)||!a.has(t)||a.get(t)!==n.get(r))if(Array.isArray(t)){var f=new o.Array;a.set(t,f),d(t,f,i),n.set(r,f)}else if(s(t)){var u=new o.Map;a.set(t,u),e(t,u,i),n.set(r,u)}else{if(!l(t))throw new Error("unsupported p type");n.set(r,t)}})},y=function(n,f){var u=r[f];if(!s(u)||a.get(u)!==n)if(n instanceof o.Array){var c=t.proxy([]);a.set(c,n),d(c,n,i),r[f]=c}else if(n instanceof o.Map){var y=t.proxy(n.toJSON());a.set(y,n),e(y,n,i),r[f]=y}else{if(!l(n))throw new Error("unsupported y type");r[f]=n}};Object.entries(r).forEach(function(t){var r=t[0],l=t[1],c=n.get(r);Array.isArray(l)&&c instanceof o.Array&&f.default(l,c.toJSON())?(a.set(l,c),d(l,c,i)):!Array.isArray(l)&&s(l)&&c instanceof o.Map&&f.default(l,c.toJSON())?(a.set(l,c),e(l,c,i)):u(l,r)}),n.forEach(function(t,n){var l=r[n];Array.isArray(l)&&t instanceof o.Array&&f.default(l,t.toJSON())?(a.set(l,t),d(l,t,i)):!Array.isArray(l)&&s(l)&&t instanceof o.Map&&f.default(l,t.toJSON())?(a.set(l,t),e(l,t,i)):y(t,n)}),t.subscribe(r,function(e){e.forEach(function(e){var t=e[1];if(1===t.length){var i=t[0];if("delete"===e[0])n.delete(i);else if("set"===e[0]){var a=r[i],s=n.get(i);f.default(s instanceof o.AbstractType?s.toJSON():s,a)||u(a,i)}}})}),n.observe(function(e){e.keysChanged.forEach(function(e){var t=n.get(e);void 0===t?delete r[e]:y(t,e)})})},d=function e(r,n,i){void 0===i&&(i={});var a=new WeakMap,l=function(t,r){if(Array.isArray(t)){var f=new o.Array;a.set(t,f),e(t,f,i),n.insert(r,[f])}else if(s(t)){var l=new o.Map;a.set(t,l),y(t,l,i),n.insert(r,[l])}else{if(!u(t))throw new Error("unsupported p type");n.insert(r,[t])}},d=function(n,f){if(n instanceof o.Array){var s=t.proxy([]);a.set(s,n),e(s,n,i),r.splice(f,0,s)}else if(n instanceof o.Map){var l=t.proxy(n.toJSON());a.set(l,n),y(l,n),r.splice(f,0,l)}else{if(!u(n))throw new Error("unsupported y type");r.splice(f,0,n)}};r.forEach(function(t,r){var c=n.get(r);Array.isArray(t)&&c instanceof o.Array&&f.default(t,c.toJSON())?a.get(t)!==c&&(a.set(t,c),e(t,c,i)):!Array.isArray(t)&&s(t)&&c instanceof o.Map&&f.default(t,c.toJSON())?a.get(t)!==c&&(a.set(t,c),y(t,c,i)):u(t)&&u(c)&&t===c||l(t,r)}),n.forEach(function(t,n){var l=r[n];Array.isArray(l)&&t instanceof o.Array&&f.default(l,t.toJSON())?a.get(l)!==t&&(a.set(l,t),e(l,t,i)):!Array.isArray(l)&&s(l)&&t instanceof o.Map&&f.default(l,t.toJSON())?a.get(l)!==t&&(a.set(l,t),y(l,t,i)):u(l)&&u(t)&&l===t||d(t,n)}),r.splice(n.length),t.subscribe(r,function(e){var t=function(e){for(var t=e.flatMap(function(e){if("resolve"===e[0]||"reject"===e[0])return[];if(1!==e[1].length)return[];var t=Number(e[1][0]);return Number.isFinite(t)?[[e[0],t,e[2],e[3]]]:[]}),r=function(e,r){for(var n=0,i=null;e+n+1<t.length;){if(("set"===t[e+n+1][0]||"insert"===t[e+n+1][0])&&t[e+n+1][1]<r&&t[e+n+1][3]===t[e][2])return n+1;if(null!==i||"set"!==t[e+n+1][0]&&"insert"!==t[e+n+1][0]||t[e+n+1][1]!==r-(n+1)||void 0!==t[e+n+1][3])if(null===i&&e+n+1<t.length&&"set"===t[e+n+1][0]&&void 0!==t[e+n+1][3])i=[e+n+1,t[e+n+1][1]],n+=1;else{if(null===i||"set"!==t[e+n+1][0]||t[e+n+1][1]!==i[1]+(n+1-i[0])||void 0===t[e+n+1][3])return null;n+=1}else n+=1}return null},n=function(e,r){for(var n=0;e+n+1<t.length&&"delete"===t[e+n+1][0]&&t[e+n+1][1]===r-(n+1);)n+=1;return n},i=0;i<t.length;)if("set"!==t[i][0]&&"insert"!==t[i][0]||void 0!==t[i][3])if(i>0&&"delete"===t[i][0]){var a=t[i][1],o=n(i,a);if("set"===t[i-1][0]&&t[i-1][1]===a-(o+1)&&t[i-1][2]===t[i][2]){var f=["delete",a-(o+1),t[i-1][3],void 0];t.splice(i-1,2),t.splice(i-1+o,0,f),i-=1}else i+=1}else i+=1;else{var s=r(i,t[i][1]);null!==s?(t.splice(i+s,1,["insert",t[i+s][1],t[i+s][2],void 0]),t.splice(i,1)):i+=1}return t}(e);f.default(n.toJSON(),r)||c(n.doc,i,function(){t.forEach(function(e){var t=e[1];if("delete"!==e[0]){var i=r[t];void 0!==i&&("set"===e[0]?(n.length>t&&n.delete(t,1),l(i,t)):"insert"===e[0]&&l(i,t))}else n.length>t&&n.delete(t,1)})})}),n.observe(function(e){if(!f.default(r,n.toJSON())){var t=0;e.changes.delta.forEach(function(e){e.retain&&(t+=e.retain),e.delete&&r.splice(t,e.delete),e.insert&&(Array.isArray(e.insert)?e.insert.forEach(function(e,r){d(e,t+r)}):d(e.insert,t),t+=e.insert.length)})}})};e.bindProxyAndYArray=d,e.bindProxyAndYMap=y});
//# sourceMappingURL=index.umd.js.map
